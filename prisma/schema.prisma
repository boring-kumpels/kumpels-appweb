// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  SUPERADMIN
  NURSE
  PHARMACY_VALIDATOR
  PHARMACY_REGENT
}

enum PatientStatus {
  ACTIVE
  DISCHARGED
  TRANSFERRED
  DECEASED
}

enum LineName {
  LINE_1
  LINE_2
  LINE_3
  LINE_4
  LINE_5
}

enum MedicationProcessStep {
  PREDESPACHO
  ALISTAMIENTO
  VALIDACION
  ENTREGA
  DEVOLUCION
}

enum ProcessStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ERROR
}

model Profile {
  id            String               @id @default(cuid())
  userId        String               @unique
  avatarUrl     String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  active        Boolean              @default(true)
  firstName     String?              @map("first_name")
  lastName      String?              @map("last_name")
  role          UserRole             @default(SUPERADMIN)

  @@index([userId])
  @@map("profiles")
}

model Bed {
  id        String   @id @default(cuid())
  number    String   // Bed number (e.g., "A1", "B3")
  lineName  LineName
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)
  
  // Relations
  patients  Patient[]
  
  @@unique([lineName, number])
  @@map("beds")
}

model Patient {
  id              String        @id @default(cuid())
  externalId      String        @unique // External system ID
  firstName       String        @map("first_name")
  lastName        String        @map("last_name")
  dateOfBirth     DateTime      @map("date_of_birth")
  gender          String
  admissionDate   DateTime      @map("admission_date")
  bedId           String
  status          PatientStatus @default(ACTIVE)
  medicalRecord   String?       @map("medical_record")
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  bed             Bed           @relation(fields: [bedId], references: [id], onDelete: Cascade)
  medicationProcesses MedicationProcess[]
  errorLogs       ProcessErrorLog[]
  manualReturns   ManualReturn[]
  
  @@index([externalId])
  @@index([bedId])
  @@index([status])
  @@map("patients")
}

model DailyProcess {
  id              String              @id @default(cuid())
  date            DateTime            @db.Date // Date of the process (YYYY-MM-DD)
  startedBy       String              // User ID who started the daily process
  startedAt       DateTime            @default(now())
  completedAt     DateTime?
  status          String              @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  medicationProcesses MedicationProcess[]
  
  @@unique([date])
  @@index([date])
  @@index([startedBy])
  @@map("daily_processes")
}

model MedicationProcess {
  id              String              @id @default(cuid())
  patientId       String
  dailyProcessId  String?             // Link to daily process session
  step            MedicationProcessStep
  status          ProcessStatus       @default(PENDING)
  startedAt       DateTime?
  completedAt     DateTime?
  startedBy       String?             // User ID who started the process
  completedBy     String?             // User ID who completed the process
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  patient         Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  dailyProcess    DailyProcess?       @relation(fields: [dailyProcessId], references: [id], onDelete: SetNull)
  errorLogs       ProcessErrorLog[]
  
  @@unique([patientId, step, dailyProcessId])
  @@index([patientId])
  @@index([step])
  @@index([status])
  @@index([dailyProcessId])
  @@map("medication_processes")
}

enum LogType {
  ERROR
  WARNING
  INFO
}

model ProcessErrorLog {
  id                  String              @id @default(cuid())
  patientId           String
  medicationProcessId String?             // Optional link to specific medication process
  step                MedicationProcessStep?  // Process step where error occurred
  logType             LogType             @default(INFO)
  message             String
  reportedBy          String              // User ID who reported the error
  reportedByRole      UserRole
  resolvedAt          DateTime?
  resolvedBy          String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  // Relations
  patient             Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medicationProcess   MedicationProcess?  @relation(fields: [medicationProcessId], references: [id], onDelete: SetNull)
  
  @@index([patientId])
  @@index([medicationProcessId])
  @@index([logType])
  @@index([createdAt])
  @@map("process_error_logs")
}

enum ManualReturnStatus {
  PENDING
  APPROVED
  REJECTED
}

model ManualReturn {
  id              String              @id @default(cuid())
  patientId       String
  generatedBy     String              // User ID who generated the return
  reviewedBy      String?             // User ID who reviewed/approved the return
  status          ManualReturnStatus  @default(PENDING)
  approvalDate    DateTime?
  cause           String
  comments        String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  patient         Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  supplies        ManualReturnSupply[]
  
  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@map("manual_returns")
}

model ManualReturnSupply {
  id              String        @id @default(cuid())
  manualReturnId  String
  supplyCode      String
  supplyName      String
  quantityReturned Int
  createdAt       DateTime      @default(now())
  
  // Relations
  manualReturn    ManualReturn  @relation(fields: [manualReturnId], references: [id], onDelete: Cascade)
  
  @@index([manualReturnId])
  @@map("manual_return_supplies")
}
